{% extends "mspsds-layout.html" %}

{% set filters = utils.caseFilters(data.caseListSettings, data.currentUser) %}
{% set sortAttr = utils.caseSortAttr(data.caseListSettings) %}
{% set sortDir = utils.caseSortDir(data.caseListSettings) %}
{% set cases = data.cases | filterCases(filters) | sort(sortDir, false, sortAttr) %}

{% from "select/macro.njk"                import govukSelect %}
{% set bodyClasses = "mspsds-width-container case-list-3" %}

{% block pageTitle %}
  Case-list Page
{% endblock %}

{% block beforeContent %}

    {{ govukPhaseBanner({
        tag: {
          text: "beta"
        },
        html: 'This is a new service â€“ your <a class="govuk-link" href="#">feedback</a> will help us to improve it.'
    }) }}

    {{ siteNavV3([
      {
        label: 'Home',
        link: '/'
      }, {
        label: 'Cases',
        link: '/root/case-list',
        classes: 'active'
      }, {
        label: 'Products',
        link: '/root/product-list'
      }, {
        label: 'Businesses',
        link: '/root/business-list'
      }
    ], data['createUrl'] ) }}

{% endblock %}






{% block content %}

  {% block pageHeader %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      {{ pageTitle({
        title: "Cases"
      }) }}
    </div>
  </div>
  {% endblock %}

  <div class="govuk-grid-row">

    <div class="govuk-grid-column-one-quarter govuk-!-margin-bottom-2 mspsds-case-control mspsds-case-filter-controls">
      <div class="govuk-!-margin-bottom-0">
          {{ headerSearch({
            action: "./case-search",
            label: "Keywords",
            value: data.caseListSettings.q
          }) }}
      </div>

      <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

      <form id="case-filters"  method="post">
        {% set assigneeHtml %}
          <label for="case-assignee-autocomplete" class="label govuk-label">Name / Team
            <div id="case-assignee-autocomplete-container"></div>
          </label>
        {% endset -%}

        {{ govukCheckboxes({

          fieldset: {
            legend: {
              text: "Assigned to",
              isPageHeading: false,
              classes: "govuk-fieldset__legend--s"
            }
          },
          classes: "govuk-!-margin-bottom-5",
          idPrefix:   "Assignee",
          name:       "caseListSettings[assignee]",
          items: [
            {
              value: "Me",
              text: "Me",
              checked: checked("caseListSettings['assignee']", "Me")
            },
            {
              value: "other",
              text: "Someone else",
              checked: checked("caseListSettings['assignee']", "other"),
              conditional: {
                html: assigneeHtml
              }
            }

          ]
        }) }}

        {{ govukCheckboxes({
          fieldset: {
            legend: {
              text: "Status",
              isPageHeading: false,
              classes: "govuk-fieldset__legend--s"
            }
          },
          classes: "govuk-!-margin-bottom-5",
          idPrefix: "Status",
          name: "caseListSettings[status]",
          items: [
            {
              value: "Open",
              text: "Open",
              checked: checked("caseListSettings['status']", "Open")
            },
            {
              value: "Closed",
              text: "Closed",
              checked: checked("caseListSettings['status']", "Closed")
            }
          ]
        }) }}

        {{ govukRadios({
          fieldset: {
            legend: {
              text: "Sort by",
              isPageHeading: false,
              classes: "govuk-fieldset__legend--s"
            }
          },
          classes: "govuk-!-margin-bottom-5",
          idPrefix:   "Sort",
          name:       "caseListSettings[sort]",
          items: [
            {
              value: "latest",
              text: "Updated: recent",
              checked: checked("caseListSettings['sort']", "latest")
            },
            {
              value: "oldest",
              text: "Updated: oldest",
              checked: checked("caseListSettings['sort']", "oldest")
            },
            {
              value: "newest",
              text: "Created: newest",
              checked: checked("caseListSettings['sort']", "newest")
            }
          ]
        }) }}

        {{ govukButton({
          text: "Apply filters"
        }) }}

      </form>

      <script type="text/javascript">
        var existingAssignees = {{data.cases | pick("assignee") | jsList | safe}} // Bit of hackery which gets nunjucks list into a js list
        var assignees = Array.from(new Set(existingAssignees)).sort();

        element = document.querySelector('#case-assignee-autocomplete-container');
        id = 'case-assignee-autocomplete';
        accessibleAutocomplete({
          element: element,
          id: id,
          name: "caseListSettings[assignee-other]",
          showNoOptionsFound: false,
          defaultValue: '{{data.caseListSettings["assignee-other"]}}',
          showAllValues: true,
          dropdownArrow: () => '',
          source: assignees
        });
      </script>
      
    </div>

    <div class="govuk-grid-column-three-quarters mspsds-case-list-tab {% if search %} mspsds-search__results {% endif %} {% if cases.length > 0 %} mspsds-search__results--empty {% endif %}">
      {% from "includes/components/case/case-card-list.html"          import caseCardList %}
      {{ caseCardList(cases, data.products, utils, search) }}
      {% if cases | length == 0 %}
          <span class="govuk-heading-xl">No results</span>
      {% endif %}
    </div>

  </div>

{% endblock %}
